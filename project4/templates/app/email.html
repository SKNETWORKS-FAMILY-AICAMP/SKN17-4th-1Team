{% block content %}
<div class="code-verify">
  <div class="code-verify__backdrop" role="dialog" aria-modal="true" aria-labelledby="cvTitle">
    <div class="code-verify__card">
      <!-- 좌측 뒤로 / 우측 닫기 -->
      <a class="code-verify__icon code-verify__icon--back" href="javascript:history.back()" aria-label="뒤로">←</a>
      <a class="code-verify__icon code-verify__icon--close" href="{% url 'app:login' %}" aria-label="닫기">×</a>

      <div class="code-verify__body">
        <h2 id="cvTitle" class="code-verify__title" aria-level="2">이메일 입력</h2>

        <div class="code-verify__group">
          <input id="cvEmail" class="code-verify__field" type="email" placeholder="you@example.com" autocomplete="username" />
          <button id="cvSend" type="button" class="code-verify__send">코드 발송하기</button>
        </div>

        <div class="code-verify__label">발송 코드 입력</div>
        <input id="cvCode" class="code-verify__field" type="text" placeholder="인증 코드 6자리" inputmode="numeric" />

        <div class="code-verify__resend">
          <a href="javascript:void(0)" id="cvResend" class="code-verify__resend-link">코드 재발송 →</a>
        </div>

        <button id="cvSubmit" type="button" class="code-verify__btn">코드 확인</button>
      </div>
    </div>
  </div>
</div>

<style>
  .code-verify{position:relative;min-height:60vh}
  .code-verify__backdrop{
    position:fixed; inset:0; display:grid; place-items:center;
    background:rgba(0,0,0,.72); padding:20px; z-index:30;
  }
  .code-verify__card{
    width:min(520px, 92vw);
    background:#e0e0e0; border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.06) inset;
    position:relative; animation:cv-pop .18s ease-out;
  }
  @keyframes cv-pop{from{opacity:.5; transform:translateY(6px) scale(.98)} to{opacity:1; transform:none}}

  .code-verify__icon{
    position:absolute; top:14px; width:38px; height:38px; border-radius:10px;
    display:grid; place-items:center; background:#f6f6f6; border:1px solid #d8d8d8;
    cursor:pointer; user-select:none; font-size:20px; color:#111; text-decoration:none;
  }
  .code-verify__icon--back{left:14px}
  .code-verify__icon--close{right:14px}
  .code-verify__icon:active{transform:translateY(1px)}

  .code-verify__body{padding:26px 26px 24px}
  .code-verify__title{margin:4px 0 10px 2px; font-weight:900; font-size:18px; color:#111}
  .code-verify__label{margin:22px 0 8px 2px; font-weight:900; font-size:16px}

  .code-verify__group{
    position:relative; display:grid; gap:6px; margin-bottom:12px;
  }
  .code-verify__field{
    width:100%; height:54px; border-radius:12px; border:1px solid #cfcfcf;
    background:#efefef; padding:0 14px; font-size:16px; outline:none;
  }
  .code-verify__field:focus{box-shadow:0 0 0 2px rgba(0,0,0,.08) inset}

  /* ✅ 작은 코드 발송 버튼 */
  .code-verify__send{
    position:absolute; right:8px; bottom:8px;
    padding:5px 10px; font-size:13px; border-radius:8px;
    background:#9c9c9c; color:#fff; border:none; cursor:pointer;
  }
  .code-verify__send:hover{background:#8b8b8b}

  .code-verify__resend{
    display:flex; justify-content:flex-end; margin-top:6px;
  }
  .code-verify__resend-link{
    font-size:13px; font-weight:800; color:#000; text-decoration:none;
  }
  .code-verify__resend-link:hover{text-decoration:underline}

  .code-verify__btn{
    margin-top:18px; width:100%; height:58px;
    border-radius:12px; border:1px solid #cfcfcf;
    background:#9c9c9c; color:#fff; font-weight:900; font-size:18px; cursor:pointer;
  }
  .code-verify__btn:hover{background:#8b8b8b}
  .code-verify__btn:active{transform:translateY(1px)}

  @media (max-width:480px){
    .code-verify__body{padding:22px}
    .code-verify__field{height:50px}
    .code-verify__send{font-size:12px; padding:4px 8px}
    .code-verify__btn{height:54px; font-size:17px}
  }
</style>

<script>
(function(){
  const sendBtn  = document.getElementById('cvSend');
  const resend   = document.getElementById('cvResend');
  const submit   = document.getElementById('cvSubmit');
  const emailInp = document.getElementById('cvEmail');
  const codeInp  = document.getElementById('cvCode');

  // CSRF 쿠키에서 토큰 읽기
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // 버튼 disable/enable
  function busy(el, on) {
    if (!el) return;
    el.disabled = !!on;
    el.style.opacity = on ? .6 : 1;
    el.style.pointerEvents = on ? 'none' : 'auto';
  }

  // 코드 발송/재발송
  async function sendCode(){
    const email = (emailInp.value || '').trim().toLowerCase();
    if (!email) { alert('이메일을 입력하세요.'); emailInp.focus(); return; }

    try {
      busy(sendBtn, true); busy(resend, true);
      const res = await fetch("{% url 'app:ajax_send_code' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrftoken
        },
        body: new URLSearchParams({ email })
      });
      const data = await res.json();
      alert((data.status === "ok" ? "✅ " : "❗ ") + (data.message || "처리 결과를 확인하세요."));
    } catch (err) {
      alert("⚠️ 오류: " + err);
    } finally {
      busy(sendBtn, false); busy(resend, false);
    }
  }

  // ✅ 인증코드 검증 → 성공 시에만 비밀번호 페이지로 이동
  async function verifyCode(){
    const email = (emailInp.value || '').trim().toLowerCase();
    const code  = (codeInp.value  || '').trim();

    if (!email) { alert('이메일을 입력하세요.'); emailInp.focus(); return; }
    if (!/^\d{6}$/.test(code)) { alert('6자리 인증코드를 입력하세요.'); codeInp.focus(); return; }

    try {
      busy(submit, true);
      const res = await fetch("{% url 'app:ajax_verify_code' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrftoken
        },
        body: new URLSearchParams({ email, code })
      });
      const data = await res.json();
      if (data.status === "ok") {
        // 서버에서 세션에 email_verified / verified_email 저장됨
        window.location.href = "{% url 'app:password' %}";
      } else {
        alert("❗ " + (data.message || "인증에 실패했습니다."));
      }
    } catch (err) {
      alert("⚠️ 오류: " + err);
    } finally {
      busy(submit, false);
    }
  }

  if (sendBtn) sendBtn.addEventListener('click', sendCode);
  if (resend)  resend.addEventListener('click', sendCode);
  if (submit)  submit.addEventListener('click', verifyCode);  // ← 여기!
})();
</script>
{% endblock content %}