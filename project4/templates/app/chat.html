<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Chat â€“ ì´ˆê¸° ì¢ê²Œ / ì—…ë¡œë“œ ì‹œ ë°˜ë°˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --panel:#dcdcdc; --panel2:#e6e6e6; --text:#111;
    --composer-h:64px; --r:18px;
    --shadow:0 1px 0 #fff inset, 0 8px 30px rgba(0,0,0,.08);
    --sidebar-w:360px;
    --gap:16px;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Malgun Gothic",sans-serif;
    background:
      radial-gradient(1200px 220px at 50% 0%, #000000a0, transparent 60%),
      linear-gradient(#ededed,#e9e9e9);
    overflow:hidden;
  }

  /* Topbar */
  .topbar{height:70px;display:flex;align-items:center;gap:12px;padding:0 18px;position:relative;z-index:20}
  .arrow{
    width:44px;height:44px;border-radius:50%;display:grid;place-items:center;
    background:#2b2b2b;color:#fff;border:1px solid #00000066;cursor:pointer;
  }
  .arrow svg{display:block}
  .spacer{flex:1}
  .actions{display:flex;gap:12px;align-items:center}
  .logout{padding:10px 18px;border-radius:24px;background:#d0d0d0;border:none;font-weight:700;cursor:pointer}
  .gear{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:#2b2b2b;color:#fff;border:1px solid #00000066;cursor:pointer}

  /* App + columns */
  .app{position:relative;height:calc(100% - 70px)}
  .columns{
    position:absolute; inset:18px;
    display:flex; gap:var(--gap);
    align-items:stretch; z-index:10;
  }

  /* ì´ˆê¸°: ì±„íŒ…ë§Œ ë³´ì—¬ì£¼ë˜ í­ ì œí•œ(ì¤‘ì•™ ë°°ì¹˜) */
  .viewer-col{display:none}
  .chat-col{flex:1; max-width:900px; margin:0 auto;} /* â˜… ì´ˆê¸° ì¢ê²Œ */

  /* ì—…ë¡œë“œ í›„: ë°˜ë°˜ ë ˆì´ì•„ì›ƒ & ì±„íŒ… í­ ì œí•œ í•´ì œ */
  .app.with-viewer .viewer-col{display:flex; flex:1}
  .app.with-viewer .chat-col{flex:1; max-width:none; margin:0;}

  /* Sidebar (off-canvas) */
  .sidebar{
    position:absolute;left:0;top:0;bottom:0;width:var(--sidebar-w);
    background:var(--panel);border-radius:18px;margin-left:18px;padding:22px;box-shadow:var(--shadow);
    transform:translateX(calc(-100% - 24px));transition:transform .28s cubic-bezier(.22,.61,.36,1);
    z-index:12;overflow:auto;
  }
  .sidebar.open{transform:translateX(0)}
  .backdrop{position:absolute;inset:0;background:transparent;pointer-events:none;transition:background .25s;z-index:11}
  .backdrop.on{background:rgba(0,0,0,.25);pointer-events:auto}

  /* Viewer ì˜ì—­ */
  .viewer-card{flex:1;background:transparent;border:none;border-radius:0;box-shadow:none;display:flex;flex-direction:column;padding:0}
  .viewer-head{ display:none }
  .viewer{flex:1;background:transparent;border:none;border-radius:0;padding:0;overflow:hidden}
  .pdf-frame{width:100%;height:100%;min-height:420px;border:none;border-radius:0;background:#fff}
  .img-frame{display:block;max-width:100%;height:auto;border:none;border-radius:0;background:#fff}
  .empty{text-align:center;color:#666;padding:16px}

  /* Chat card */
  .chat-card{flex:1;background:var(--panel);border-radius:18px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column}
  .room-title{font-weight:900;padding:4px 8px;display:flex;gap:8px;align-items:center}
  .room-title small{font-weight:600;color:#555}
  .chat{flex:1;overflow:auto;background:#dedede;border-radius:12px;padding:16px 16px 24px;margin-top:6px;padding-bottom:calc(var(--composer-h) + 24px)}
  .msg{display:flex;gap:10px;align-items:flex-end;margin-bottom:16px}
  .me{justify-content:flex-end}
  .ava{width:40px;height:40px;border-radius:50%;background:#cfcfcf;display:grid;place-items:center;flex-shrink:0}
  .bub{background:#fff;border-radius:18px;padding:16px 18px;max-width:62ch;box-shadow:0 1px 0 #fff inset, 0 2px 8px rgba(0,0,0,.06)}
  .me .bub{border-top-right-radius:8px}
  .them .bub{border-top-left-radius:8px}

  /* Composer */
  .composer{
    position:relative; margin-top:12px; height:var(--composer-h);
    background:var(--panel2); border:1px solid #c7c7c7; border-radius:14px;
    display:flex; align-items:center; gap:10px; padding:10px 12px;
  }
  .upload,.send{width:40px;height:40px;border-radius:50%;border:1px solid #cdcdcd;background:#fff;display:grid;place-items:center;cursor:pointer}
  .input{flex:1;height:40px;border:none;outline:none;background:transparent;font-size:16px}
  .hint{position:absolute; right:8px; bottom:-18px; font-size:12px; color:#333; user-select:none}

  /* Sidebar content */
  .title{font-weight:900;margin:2px 0 12px}
  .rule{height:2px;background:#bdbdbd;border-radius:2px;margin:10px 0 16px}
  .item{background:#d0d0d0;border-radius:12px;padding:12px 14px;margin-bottom:10px;cursor:pointer}
  .item.active{background:#fff;box-shadow:0 0 0 1px #00000010 inset}
  .row{display:flex;align-items:center;justify-content:space-between;font-weight:800}
  .title-text{display:inline-flex;gap:8px;align-items:center}
  .dot{width:8px;height:8px;background:#222;border-radius:50%}
  .date{font-size:13px;color:#666;margin-top:4px}
  .close{width:24px;height:24px;border-radius:50%;display:grid;place-items:center;border:1px solid #bdbdbd;background:#f5f5f5;cursor:pointer}
  .adder{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:8px;color:#444;font-weight:700;cursor:pointer}
  .adder .plus{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;border:2px solid #777}

  /* ê³µí†µ ëª¨ë‹¬ ë˜í¼ */
  .modal-wrap{display:none;place-items:center;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:30}
  .modal-card{width:min(480px,92vw);background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative}
  .modal-title{font-weight:900;margin:0 0 10px 0;text-align:center}
  .modal-x{position:absolute;right:10px;top:10px;border:none;background:#000;color:#fff;width:26px;height:26px;border-radius:50%;cursor:pointer}

  /* ê¸°ë³¸ ë²„íŠ¼ */
  .btn{display:block;width:100%;padding:12px 0;border:none;border-radius:10px;font-weight:800;cursor:pointer}
  .btn-gray{background:#e6e6e6}
  .btn-primary{background:#2b2b2b;color:#fff}
  .btn-red{background:#cf4741;color:#fff}
  .btn-row{display:flex;gap:10px;margin-top:12px}

  /* ê¸°ì¡´ ì„¤ì • ëª¨ë‹¬ */
  .settings-wrap{display:none;place-items:center;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:28}
  .settings-card{width:min(420px,92vw);background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative}
  .settings-title{font-weight:900;margin:0 0 10px 0;text-align:center}
  .settings-x{position:absolute;right:10px;top:10px;border:none;background:#000; color:#fff; width:26px;height:26px;border-radius:50%;cursor:pointer}
  .link{color:#1e5eff;cursor:pointer;text-decoration:underline;display:block;margin:8px 0}
  .desc{font-size:12px;color:#444;margin-top:8px;line-height:1.5}

  /* Responsive */
  @media (max-width: 980px){
    .columns{flex-direction:column}
    .app.with-viewer .viewer-col{display:flex}
    .app.with-viewer .chat-col{flex:auto}
    .chat-col{max-width:100%; margin:0;}
    .pdf-frame{height:60vh}
  }
</style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="arrow" id="toggleSidebar" title="ê³¼ê±° ì±„íŒ… ì—´ê¸°" aria-pressed="false">
      <svg id="ico-open" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5l8 7-8 7z" fill="currentColor"/></svg>
      <svg id="ico-close" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" style="display:none"><path d="M16 5l-8 7 8 7z" fill="currentColor"/></svg>
    </div>
    <div class="spacer"></div>
    <div class="actions">
      <button class="logout" id="logoutBtn">Log Out</button>
      <div class="gear" id="openSettings" title="ì„¤ì •">âš™</div>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="title">ê³¼ê±° ì±„íŒ…</div>
      <div class="rule"></div>

      <!-- ì´ˆê¸° ë”ë¯¸ ì•„ì´í…œ -->
      <div class="item" data-id="1" onclick="activateChat(this)">
        <div class="row">
          <span class="title-text"><span class="dot"></span><span class="label">ì±„íŒ… 1ë²ˆ</span></span>
          <span class="close" onclick="event.stopPropagation(); removeChat(this)">Ã—</span>
        </div>
        <div class="date">ì‹œì‘ì¼ : <span class="date-text">2025.10.14</span></div>
      </div>

      <div class="item active" data-id="2" onclick="activateChat(this)">
        <div class="row">
          <span class="title-text"><span class="dot"></span><span class="label">ì±„íŒ… 2ë²ˆ</span></span>
          <span class="close" onclick="event.stopPropagation(); removeChat(this)">Ã—</span>
        </div>
        <div class="date">ì‹œì‘ì¼ : <span class="date-text">2025.10.16</span></div>
      </div>

      <div class="rule"></div>
      <div class="adder" id="addChat"><div class="plus">ï¼‹</div> ìƒˆ ì±„íŒ…</div>
    </aside>
    <div class="backdrop" id="backdrop"></div>

    <!-- Columns -->
    <div class="columns">
      <!-- Viewer (hidden until upload) -->
      <section class="viewer-col">
        <div class="viewer-card">
          <div class="viewer-head">ë¬¸ì„œ ë¯¸ë¦¬ë³´ê¸°</div>
          <div class="viewer" id="viewer">
            <div class="empty" id="emptyState">ì—…ë¡œë“œí•œ PDF/ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </section>

      <!-- Chat (center-narrow initially) -->
      <section class="chat-col">
        <div class="chat-card">
          <div class="room-title" id="roomTitle">
            <span class="dot" style="width:8px;height:8px;background:#222;border-radius:50%"></span>
            <span class="room-name">ì±„íŒ… 2ë²ˆ</span>
            <small class="room-date">2025.10.16</small>
          </div>
          <div class="chat" id="chat"></div>
          <div class="composer">
            <button class="upload" id="uploadBtn" title="ì—…ë¡œë“œ(íŒŒì¼)">â¬†</button>
            <input type="file" id="fileInput" accept="image/*,application/pdf,.pdf" multiple hidden />
            <input class="input" id="textInput" maxlength="1000" placeholder="ë¬¼ì–´ë³´ê¸°" />
            <button class="send" id="sendBtn" title="ë³´ë‚´ê¸°">â¤</button>
            <div class="hint">ìµœëŒ€ 1000ê¸€ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ (1ì°¨) -->
  <div class="settings-wrap" id="settingsWrap" aria-hidden="true">
    <div class="settings-card" role="dialog" aria-modal="true" aria-labelledby="stitle">
      <button class="settings-x" id="settingsClose" aria-label="ë‹«ê¸°">Ã—</button>
      <h3 class="settings-title" id="stitle">ì„¤ì •</h3>

      <a class="link" id="linkTerms">ì„œë¹„ìŠ¤ ì´ìš© ì•½ê´€ í™•ì¸í•˜ê¸°</a>
      <a class="link" id="linkPrivacy">ê°œì¸ì •ë³´ ë³´í˜¸ì •ì±… í™•ì¸í•˜ê¸°</a>
      <a class="link" id="linkPwd">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ê¸°</a>

      <p class="desc">íƒˆí‡´í•œ ë’¤ì—ëŠ” ê³„ì • ë³µêµ¬ ë¶ˆê°€</p>
      <button class="btn btn-red" id="settingsOk">íƒˆí‡´</button>
    </div>
  </div>

  <!-- PDF ì—…ë¡œë“œ ì•ˆë‚´ ëª¨ë‹¬ (ê·¸ë¦¼1) -->
  <div class="modal-wrap" id="pdfGuideWrap" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pdfTitle">
      <button class="modal-x" id="pdfGuideClose" aria-label="ë‹«ê¸°">Ã—</button>
      <h3 class="modal-title" id="pdfTitle">PDF ì—…ë¡œë“œ ì•ˆë‚´</h3>
      <div style="color:#444;line-height:1.6;margin:12px 0">
        PDF ì—…ë¡œë“œëŠ” ìµœì´ˆ 1íšŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br/>
        1íšŒ ì—…ë¡œë“œ í›„ì—ëŠ” PDF ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<br/>
        PDF ì—…ë¡œë“œë¥¼ ì›í•˜ì‹ ë‹¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
      </div>
      <button class="btn btn-primary" id="pdfGuideOk">PDF ì—…ë¡œë“œí•˜ê¸°</button>
    </div>
  </div>

  <!-- íƒˆí‡´ ìµœì¢… í™•ì¸ ëª¨ë‹¬ (ê·¸ë¦¼2) -->
  <div class="modal-wrap" id="leaveConfirmWrap" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="leaveTitle">
      <button class="modal-x" id="leaveConfirmClose" aria-label="ë‹«ê¸°">Ã—</button>
      <h3 class="modal-title" id="leaveTitle">ì •ë§ íƒˆí‡´í•˜ì‹œê² ì–´ìš”?</h3>
      <div style="color:#444;line-height:1.6;margin:12px 0">
        ê³„ì •ì„ íƒˆí‡´í•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      </div>
      <div class="btn-row">
        <button class="btn btn-gray" id="leaveCancel">ì·¨ì†Œ</button>
        <button class="btn btn-red" id="leaveConfirmYes">íƒˆí‡´</button>
      </div>
    </div>
  </div>

<script>
  /* ===== CSRF í† í° ìœ í‹¸ ===== */
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  /* ===== ê³µí†µ ìš”ì†Œ ===== */
  const app = document.getElementById('app');
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('backdrop');
  const viewer = document.getElementById('viewer');
  const emptyState = document.getElementById('emptyState');
  const chatEl = document.getElementById('chat');

  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const textInput = document.getElementById('textInput');

  const roomTitle = document.getElementById('roomTitle');
  const roomNameEl = roomTitle.querySelector('.room-name');
  const roomDateEl = roomTitle.querySelector('.room-date');

  /* ===== ë‚ ì§œ í¬ë§· ===== */
  function formatDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}.${m}.${day}`;
  }

  /* ===== ì‚¬ì´ë“œë°” í† ê¸€ ===== */
  const toggleBtn = document.getElementById('toggleSidebar');
  const icoOpen = document.getElementById('ico-open');
  const icoClose = document.getElementById('ico-close');
  function openSidebar(){ sidebar.classList.add('open'); backdrop.classList.add('on'); toggleBtn.setAttribute('aria-pressed','true'); icoOpen.style.display='none'; icoClose.style.display='block'; }
  function closeSidebar(){ sidebar.classList.remove('open'); backdrop.classList.remove('on'); toggleBtn.setAttribute('aria-pressed','false'); icoOpen.style.display='block'; icoClose.style.display='none'; }
  toggleBtn.addEventListener('click', ()=> sidebar.classList.contains('open') ? closeSidebar() : openSidebar());
  backdrop.addEventListener('click', closeSidebar);

  /* ===== ë©”ì‹œì§€ ë Œë” ===== */
  function renderItem(it){
    const row = document.createElement('div');
    row.className = 'msg ' + (it.me ? 'me' : 'them');
    row.innerHTML = it.me
      ? `<div class="bub"></div><div class="ava">ë‚˜</div>`
      : `<div class="ava">ğŸ˜Š</div><div class="bub"></div>`;
    row.querySelector('.bub').textContent = it.content;
    chatEl.appendChild(row);
  }

  async function loadList(){
    const res = await fetch("/app/chat/api/list/");
    const data = await res.json();
    chatEl.innerHTML = "";
    if (data.ok){
      data.items.forEach(renderItem);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
  }

  async function sendMsg(){
    const v = textInput.value.trim();
    if (!v) return;
    const form = new FormData();
    form.append('content', v);

    const res = await fetch("/app/chat/api/send/", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: form
    });
    const data = await res.json();
    if (!data.ok){
      alert(data.error || "ì „ì†¡ ì‹¤íŒ¨");
      return;
    }
    textInput.value = "";
    // ë‚™ê´€ì  ë Œë”(ë°”ë¡œ í‘œì‹œ)
    renderItem({content: v, me: true});
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  sendBtn.addEventListener('click', sendMsg);
  textInput.addEventListener('keydown', e=>{
    if (e.key === 'Enter'){ e.preventDefault(); sendMsg(); }
  });

  /* ===== Viewer: ì´ˆê¸°í™” & í‘œì‹œ ===== */
  let lastObjectURL = null;
  function resetViewer(){
    if (lastObjectURL && lastObjectURL.startsWith('blob:')) {
      try { URL.revokeObjectURL(lastObjectURL); } catch(e){}
    }
    lastObjectURL = null;
    app.classList.remove('with-viewer');
    viewer.innerHTML = '';
    if (emptyState){
      emptyState.style.display = '';
      viewer.appendChild(emptyState);
    }
  }
  function showViewer(){ app.classList.add('with-viewer'); }
  function viewPDF(url){
    showViewer();
    if (emptyState) emptyState.style.display = 'none';
    lastObjectURL = url;
    const hash = '#toolbar=0&navpanes=0&statusbar=0&scrollbar=0&view=FitH&zoom=page-width';
    const cleanUrl = url.includes('#') ? url.split('#')[0] : url;
    const pdfUrl = cleanUrl + hash;
    viewer.innerHTML = `<iframe class="pdf-frame" src="${pdfUrl}" title="PDF ë¯¸ë¦¬ë³´ê¸°" loading="lazy"></iframe>`;
  }
  function viewImage(dataUrl){
    showViewer();
    if(emptyState) emptyState.style.display='none';
    viewer.innerHTML = `<img class="img-frame" src="${dataUrl}" alt="preview">`;
  }
  function viewUnsupported(name, url){
    showViewer();
    if(emptyState) emptyState.style.display='none';
    lastObjectURL = url;
    viewer.innerHTML = `
      <div style="padding:16px;background:#fff;border-radius:12px;border:1px solid #d0d0d0">
        <div style="font-weight:800;margin-bottom:6px">ë¯¸ë¦¬ë³´ê¸° ë¶ˆê°€ íŒŒì¼</div>
        <div>${name}</div>
        <div style="margin-top:8px"><a href="${url}" download>ë‹¤ìš´ë¡œë“œ</a></div>
      </div>`;
  }

  /* ===== ì—…ë¡œë“œ â†’ ê°€ì´ë“œ ëª¨ë‹¬(ê·¸ë¦¼1) â†’ íŒŒì¼ì„ íƒ ===== */
  const pdfGuideWrap = document.getElementById('pdfGuideWrap');
  const pdfGuideOk = document.getElementById('pdfGuideOk');
  const pdfGuideClose = document.getElementById('pdfGuideClose');

  function openModal(el){ el.style.display='grid'; el.setAttribute('aria-hidden','false'); }
  function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }

  uploadBtn.addEventListener('click', ()=> openModal(pdfGuideWrap));
  pdfGuideOk.addEventListener('click', ()=>{
    closeModal(pdfGuideWrap);
    fileInput.click();
  });
  pdfGuideClose.addEventListener('click', ()=> closeModal(pdfGuideWrap));
  pdfGuideWrap.addEventListener('click', e=>{ if(e.target===pdfGuideWrap) closeModal(pdfGuideWrap); });

  /* ===== íŒŒì¼ ì„ íƒ í›„ ë¯¸ë¦¬ë³´ê¸° ===== */
  const viewerEl = document.getElementById('viewer');
  const emptyStateEl = document.getElementById('emptyState');

  fileInput.addEventListener('change', e=>{
    const files=Array.from(e.target.files||[]); if(!files.length) return;
    files.forEach(file=>{
      if(file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf')){
        const url=URL.createObjectURL(file); viewPDF(url); return;
      }
      if(file.type.startsWith('image/')){
        const r=new FileReader(); r.onload=ev=>viewImage(ev.target.result); r.readAsDataURL(file); return;
      }
      const url=URL.createObjectURL(file); viewUnsupported(file.name,url);
    });
    fileInput.value='';
  });

  /* ===== ì±„íŒ… ì•„ì´í…œ í•¸ë“¤ë§ ===== */
  const addChatBtn=document.getElementById('addChat');

  function getChatItems(){ return Array.from(sidebar.querySelectorAll('.item')); }

  function renumberChats(){
    const items = getChatItems();
    items.forEach((item, idx)=>{
      const n = idx + 1;
      item.dataset.id = String(n);
      const labelEl = item.querySelector('.label');
      if (labelEl) labelEl.textContent = `ì±„íŒ… ${n}ë²ˆ`;
    });
  }

  function updateRoomHeaderFromItem(item){
    const nameText = item.querySelector('.label')?.textContent ?? 'ì±„íŒ…';
    const dateText = item.querySelector('.date-text')?.textContent ?? '';
    roomNameEl.textContent = nameText;
    roomDateEl.textContent = dateText;
  }

  addChatBtn.addEventListener('click', ()=>{
    const nextIndex = getChatItems().length + 1;
    const stamp = formatDate(new Date());
    document.querySelectorAll('.item.active').forEach(el=>el.classList.remove('active'));
    const item=document.createElement('div');
    item.className='item active'; item.dataset.id=String(nextIndex);
    item.onclick=function(){ activateChat(item); };
    item.innerHTML = `
      <div class="row">
        <span class="title-text"><span class="dot"></span><span class="label">ì±„íŒ… ${nextIndex}ë²ˆ</span></span>
        <span class="close" onclick="event.stopPropagation(); removeChat(this)">Ã—</span>
      </div>
      <div class="date">ì‹œì‘ì¼ : <span class="date-text">${stamp}</span></div>
    `;
    sidebar.insertBefore(item, addChatBtn);
    renumberChats();
    updateRoomHeaderFromItem(item);
    openSidebar();
    resetViewer();
  });

  window.activateChat = function(el){
    document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    updateRoomHeaderFromItem(el);
    closeSidebar();
  }

  window.removeChat = function(btn){
    const item = btn.closest('.item');
    const wasActive = item.classList.contains('active');
    item.remove();
    renumberChats();
    const items = getChatItems();
    if (wasActive && items.length){
      items[0].classList.add('active');
      updateRoomHeaderFromItem(items[0]);
    }
    if (!items.length){
      roomNameEl.textContent = 'ì±„íŒ…';
      roomDateEl.textContent = '';
      resetViewer();
    }
  }

  /* ===== ì„¤ì • ëª¨ë‹¬ ===== */
  const settingsWrap = document.getElementById('settingsWrap');
  const openSettings = document.getElementById('openSettings');
  const closeSettings = ()=>{ settingsWrap.style.display='none'; settingsWrap.setAttribute('aria-hidden','true'); }
  const showSettings = ()=>{ settingsWrap.style.display='grid'; settingsWrap.setAttribute('aria-hidden','false'); }
  openSettings.addEventListener('click', showSettings);
  document.getElementById('settingsClose').addEventListener('click', closeSettings);

  // ì„¤ì •ì˜ 'íƒˆí‡´' â†’ ìµœì¢… í™•ì¸ ëª¨ë‹¬
  const settingsOk = document.getElementById('settingsOk');
  const leaveConfirmWrap = document.getElementById('leaveConfirmWrap');
  const leaveConfirmClose = document.getElementById('leaveConfirmClose');
  const leaveCancel = document.getElementById('leaveCancel');
  const leaveConfirmYes = document.getElementById('leaveConfirmYes');

  settingsOk.addEventListener('click', ()=>{
    closeSettings();
    openModal(leaveConfirmWrap);
  });

  leaveConfirmClose.addEventListener('click', ()=> closeModal(leaveConfirmWrap));
  leaveCancel.addEventListener('click', ()=> closeModal(leaveConfirmWrap));
  leaveConfirmWrap.addEventListener('click', e=>{ if(e.target===leaveConfirmWrap) closeModal(leaveConfirmWrap); });

  // ìµœì¢… íƒˆí‡´ â†’ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
  leaveConfirmYes.addEventListener('click', ()=>{
    window.location.href = '/app/';
  });

  /* ===== ë§í¬ ì´ë™ & ë¡œê·¸ì•„ì›ƒ ===== */
  document.getElementById('linkTerms').addEventListener('click', ()=>{ window.location.href='/app/terms'; });
  document.getElementById('linkPrivacy').addEventListener('click', ()=>{ window.location.href='privacy.html'; });
  document.getElementById('linkPwd').addEventListener('click', ()=>{ window.location.href='/app/reset-password/new/'; });
  document.getElementById('logoutBtn').addEventListener('click', () => {
    window.location.href = '/app';
  });

  /* ===== ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸° ===== */
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      [pdfGuideWrap, leaveConfirmWrap, settingsWrap].forEach(w=>{
        if(w && w.style.display === 'grid'){ w.style.display='none'; w.setAttribute('aria-hidden','true'); }
      });
    }
  });

  /* ===== ì²« ë¡œë”© ì‹œ DBì—ì„œ ìµœê·¼ ë©”ì‹œì§€ ë¡œë“œ ===== */
  loadList();
</script>
</body>
</html>
