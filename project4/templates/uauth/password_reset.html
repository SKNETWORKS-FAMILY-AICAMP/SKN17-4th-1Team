{% block title %}비밀번호 재설정{% endblock title %}

{% block content %}
<div class="auth-wrap">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
    <div class="modal-head">
      <a class="icon-btn" href="javascript:history.back()" aria-label="뒤로">←</a>
      <div class="title" id="resetTitle">비밀번호 재설정</div>
      <a class="icon-btn x" href="{% url 'uauth:login' %}" aria-label="닫기">×</a>
    </div>

    {% if messages %}
      <ul class="err-list">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <form id="pwResetForm" method="post" action="{% url 'uauth:password_reset' %}">
      {% csrf_token %}
      <input type="hidden" name="step" id="step" value="{{ step }}">

      <!-- STEP 1: 이메일 입력 -->
      {% if step == 1 %}
        <div class="field">
          <label class="label" for="email">이메일 주소 입력</label>
          <input type="email" name="email" id="email" class="input" placeholder="이메일" required>
        </div>
        <button type="submit" class="btn">임시 비밀번호 발송</button>
      {% endif %}

      <!-- STEP 2: 임시 비밀번호 입력 -->
      {% if step == 2 %}
        <div class="field">
          <label class="label" for="temp_password">임시 비밀번호 입력</label>
          <input type="password" name="temp_password" id="temp_password" class="input" placeholder="임시 비밀번호" required>
        </div>
        <input type="hidden" name="email" value="{{ email }}">
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button type="submit" class="btn">비밀번호 설정하기</button>
          <button type="button" class="btn" id="resendBtn">재발송</button>
        </div>
      {% endif %}

      <!-- STEP 3: 새 비밀번호 설정 -->
      {% if step == 3 %}
        <div class="field">
          <label class="label" for="password1">새 비밀번호</label>
          <input type="password" name="password1" id="password1" class="input" placeholder="새 비밀번호" required>
        </div>
        <div class="field">
          <label class="label" for="password2">비밀번호 재입력</label>
          <input type="password" name="password2" id="password2" class="input" placeholder="새 비밀번호 재입력" required>
        </div>
        <button type="submit" class="btn">비밀번호 변경</button>
      {% endif %}
    </form>
  </div>
</div>

<style>
  /* 공통 스타일 */
  .auth-wrap{min-height:100vh; display:grid; place-items:center; background:#f0f0f0; padding:24px}
  .modal{width:min(420px,92vw); background:#fff; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); color:#111}
  .modal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .title{font-weight:900; flex:1; text-align:center}
  .icon-btn{width:32px;height:32px;display:grid;place-items:center; background:#eee; border-radius:50%; text-decoration:none; color:#111; cursor:pointer}
  .field{margin:10px 0}
  .label{font-weight:700; margin-bottom:6px; display:block}
  .input{width:100%; height:42px; border-radius:10px; border:1px solid #ccc; padding:0 12px; font-size:16px}
  .btn{width:100%; height:46px; border:none; border-radius:10px; background:#2b2b2b; color:#fff; font-weight:800; cursor:pointer; margin-top:12px}
  .btn:disabled{opacity:.45; cursor:not-allowed}
  .err-list{color:#cf2c2c; margin:6px 0 10px; padding-left:18px}
</style>

<script>
  (function(){
    const resendBtn = document.getElementById('resendBtn');
    if(resendBtn){
      resendBtn.addEventListener('click', function(){
        const email = document.getElementById('email').value || "{{ email }}";
        fetch("{% url 'uauth:password_reset' %}", {
          method:'POST',
          headers:{
            'X-CSRFToken':'{{ csrf_token }}',
            'Content-Type':'application/x-www-form-urlencoded'
          },
          body: `step=1&email=${encodeURIComponent(email)}`
        }).then(res=>res.text()).then(()=>alert('임시 비밀번호가 재발송되었습니다.'));
      });
    }
  })();
</script>
{% endblock content %}
